<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kh.healthcare.board.honeyTip.HoneyTipMapper">

    <select id="list">
        SELECT
            B.NO,
            B.CATEGORY_NO,
            C.NAME AS CATEGORY_NAME,
            M.NICK,
            B.MEMBER_NO,
            B.TITLE,
            B.CONTENT,
            (SELECT COUNT(*) FROM BOARD_RECOMMEND R WHERE R.BOARD_NO = B.NO) AS RECOMMEND_COUNT,
            (SELECT COUNT(*) FROM BOARD_COMMENT BC WHERE BC.BOARD_NO = B.NO AND BC.DEL_YN = 'N') AS COMMENT_COUNT,
            B.HIT,
            CASE
                WHEN TRUNC(B.MODIFY_DATE) = TRUNC(SYSDATE)
                THEN TO_CHAR(B.MODIFY_DATE, 'HH24:MI')
                ELSE TO_CHAR(B.MODIFY_DATE, 'YY.MM.DD')
            END AS MODIFY_DATE,
            CASE
                WHEN TRUNC(B.ENROLL_DATE) = TRUNC(SYSDATE)
                THEN TO_CHAR(B.ENROLL_DATE, 'HH24:MI')
                ELSE TO_CHAR(B.ENROLL_DATE, 'YY.MM.DD')
            END AS ENROLL_DATE
        FROM BOARD B
        JOIN MEMBER M ON ( B.MEMBER_NO = M.NO )
        JOIN CATEGORY C ON ( B.CATEGORY_NO = C.NO )
        WHERE B.DEL_YN = 'N'
        <if test="category != null and category != '' and category != '0' and category != '' and category != 0">
            AND B.CATEGORY_NO = #{category}
        </if>

        <if test="searchValue != null and searchValue != ''">
            <choose>
                <when test="searchType == 1">
                    AND B.CONTENT LIKE '%' || #{searchValue} || '%'
                </when>
                <when test="searchType == 2">
                    AND (B.CONTENT LIKE '%' || #{searchValue} || '%'
                    OR B.TITLE LIKE '%' || #{searchValue} || '%')
                </when>
                <when test="searchType == 3">
                    AND M.NICK LIKE '%' || #{searchValue} || '%'
                </when>
                <otherwise>
                    AND B.TITLE LIKE '%' || #{searchValue} || '%'
                </otherwise>
            </choose>
        </if>
        <choose>
            <when test="order == 1">
                ORDER BY B.NO ASC
            </when>
            <when test="order == 2">
                ORDER BY B.HIT DESC
            </when>
            <when test="order == 3">
                ORDER BY RECOMMEND_COUNT DESC
            </when>
            <otherwise>
                ORDER BY B.NO DESC
            </otherwise>
        </choose>
    </select>

    <insert id="insertAttachHoneyBoard">
        INSERT ALL
        <foreach collection="list" item="x">
            INTO BOARD_ATTACHMENT
            (
                NO
                , BOARD_NO
                , ORIGIN_NAME
                , PATH
            )
            VALUES
            (
                (SELECT GET_BOARD_ATTACHMENT_NO FROM DUAL)
                , SEQ_BOARD.CURRVAL
                , #{x.originName}
                , #{x.path}
            )
        </foreach>
        SELECT 1 FROM DUAL
    </insert>


</mapper>